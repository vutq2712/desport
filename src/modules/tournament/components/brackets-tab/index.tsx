import { useCallback, useEffect, useState } from "react";
import { BracketDetail } from "./detail";
import { BracketsOverview } from "./overview";
import { BracketData, listBracket } from "@app/api/bracket/list-bracket"
import { useRouter } from 'next/router';
import { useTournamentContext } from "@app/modules/tournament/context/tournament-context";
import { useSubscription } from "@app/hooks/subscription";

const SUMMARY_TAB = '0';

export function BracketsTab() {
  const subscription = useSubscription();
  const [brackets, setBrackets] = useState<BracketData[]>([]);
  const [selectedTab, setSelectedTab] = useState(SUMMARY_TAB);
  const router = useRouter();
  const tournamentId = router.query.tournamentId as string;

  const tournamentCtx = useTournamentContext();

  useEffect(() => {
    const listBracketSub = listBracket({ tournamentId })
      .subscribe(res => {
        setBrackets(res.data);
      });

    subscription.add(listBracketSub);
  }, [setSelectedTab, subscription, tournamentId]);

  const handleViewBracket = useCallback((bracketId: string) => {
    setSelectedTab(bracketId);
  }, []);

  return (
    <div className='de-brackets-tab'>
      <div className='de-brackets-tabs'>
        <button type='button' className={`de-bracket-tab-item ${selectedTab === SUMMARY_TAB ? 'active' : ''}`} onClick={() => setSelectedTab(SUMMARY_TAB)}>
          <span>Summary {brackets.length} teams</span>
        </button>

        {brackets.map((bracket) =>
          <button key={bracket._id} type='button' className={`de-bracket-tab-item ${selectedTab === bracket._id ? 'active' : ''}`} onClick={() => setSelectedTab(bracket._id)}>
            <div className='bracket-tab-logo'>
              <svg width='32' height='32' viewBox='0 0 32 32' fill='none' xmlns='http://www.w3.org/2000/svg'>
                <path d='M25.0533 15.76C24.9216 15.7629 24.7907 15.7384 24.6691 15.6879C24.5474 15.6373 24.4376 15.562 24.3467 15.4666L17.4 8.53329C17.2234 8.34372 17.1272 8.09299 17.1318 7.83392C17.1363 7.57485 17.2413 7.32767 17.4245 7.14446C17.6077 6.96124 17.8549 6.85629 18.114 6.85172C18.373 6.84715 18.6238 6.94331 18.8133 7.11995L25.76 14.0533C25.9473 14.2408 26.0525 14.495 26.0525 14.76C26.0525 15.025 25.9473 15.2791 25.76 15.4666C25.6677 15.5601 25.5576 15.6342 25.4363 15.6846C25.3149 15.7349 25.1847 15.7606 25.0533 15.76V15.76Z' fill='#8B5CE4' />
                <path d='M18.1733 15.6932C18.042 15.6938 17.9118 15.6682 17.7904 15.6178C17.6691 15.5675 17.559 15.4934 17.4667 15.3999C17.2794 15.2124 17.1742 14.9582 17.1742 14.6932C17.1742 14.4282 17.2794 14.1741 17.4667 13.9866L24.4133 7.05322C24.5053 6.95888 24.6152 6.8839 24.7365 6.8327C24.8579 6.7815 24.9883 6.75513 25.12 6.75513C25.2517 6.75513 25.3821 6.7815 25.5035 6.8327C25.6249 6.8839 25.7348 6.95888 25.8267 7.05322C26.0139 7.24072 26.1191 7.49489 26.1191 7.75989C26.1191 8.02489 26.0139 8.27905 25.8267 8.46655L18.88 15.3999C18.7881 15.494 18.6782 15.5685 18.5567 15.6189C18.4353 15.6693 18.3048 15.6946 18.1733 15.6932V15.6932Z' fill='#8B5CE4' />
                <path d='M10.3867 15.7333C9.49534 15.7333 8.62402 15.469 7.8829 14.9738C7.14179 14.4786 6.56416 13.7748 6.22306 12.9513C5.88196 12.1278 5.79271 11.2216 5.9666 10.3474C6.14049 9.47323 6.56971 8.67021 7.19998 8.03995C7.83025 7.40968 8.63326 6.98046 9.50747 6.80657C10.3817 6.63268 11.2878 6.72192 12.1113 7.06302C12.9348 7.40412 13.6386 7.98175 14.1338 8.72287C14.629 9.46399 14.8933 10.3353 14.8933 11.2266C14.8898 12.4208 14.4139 13.565 13.5695 14.4094C12.7251 15.2539 11.5808 15.7298 10.3867 15.7333V15.7333ZM10.3867 8.71997C9.8909 8.71997 9.40626 8.86699 8.99404 9.14242C8.58182 9.41786 8.26054 9.80935 8.07082 10.2674C7.88109 10.7254 7.83145 11.2294 7.92817 11.7157C8.02489 12.2019 8.26363 12.6486 8.61419 12.9991C8.96476 13.3497 9.4114 13.5884 9.89765 13.6851C10.3839 13.7819 10.8879 13.7322 11.3459 13.5425C11.804 13.3528 12.1955 13.0315 12.4709 12.6193C12.7463 12.207 12.8933 11.7224 12.8933 11.2266C12.8933 10.5618 12.6292 9.92425 12.1592 9.45416C11.6891 8.98407 11.0515 8.71997 10.3867 8.71997V8.71997Z' fill='white' />
                <path d='M10.3867 26.6667C9.49534 26.6667 8.62402 26.4023 7.8829 25.9071C7.14179 25.4119 6.56416 24.7081 6.22306 23.8846C5.88196 23.0611 5.79271 22.155 5.9666 21.2808C6.14049 20.4066 6.56971 19.6036 7.19998 18.9733C7.83025 18.343 8.63326 17.9138 9.50747 17.7399C10.3817 17.566 11.2878 17.6553 12.1113 17.9964C12.9348 18.3375 13.6386 18.9151 14.1338 19.6562C14.629 20.3973 14.8933 21.2687 14.8933 22.16C14.8898 23.3542 14.4139 24.4984 13.5695 25.3428C12.7251 26.1872 11.5808 26.6631 10.3867 26.6667V26.6667ZM10.3867 19.6533C9.8909 19.6533 9.40626 19.8003 8.99404 20.0758C8.58182 20.3512 8.26054 20.7427 8.07082 21.2007C7.88109 21.6588 7.83145 22.1628 7.92817 22.649C8.02489 23.1353 8.26363 23.5819 8.61419 23.9325C8.96476 24.283 9.4114 24.5218 9.89765 24.6185C10.3839 24.7152 10.8879 24.6656 11.3459 24.4758C11.804 24.2861 12.1955 23.9648 12.4709 23.5526C12.7463 23.1404 12.8933 22.6558 12.8933 22.16C12.8933 21.4952 12.6292 20.8576 12.1592 20.3875C11.6891 19.9174 11.0515 19.6533 10.3867 19.6533V19.6533Z' fill='white' />
                <path d='M21.6133 26.6667C20.722 26.6667 19.8507 26.4023 19.1096 25.9071C18.3685 25.4119 17.7908 24.7081 17.4497 23.8846C17.1086 23.0611 17.0194 22.155 17.1933 21.2808C17.3672 20.4066 17.7964 19.6036 18.4266 18.9733C19.0569 18.343 19.8599 17.9138 20.7341 17.7399C21.6083 17.566 22.5145 17.6553 23.338 17.9964C24.1615 18.3375 24.8653 18.9151 25.3605 19.6562C25.8557 20.3973 26.12 21.2687 26.12 22.16C26.1165 23.3542 25.6406 24.4984 24.7962 25.3428C23.9517 26.1872 22.8075 26.6631 21.6133 26.6667V26.6667ZM21.6133 19.6533C21.1176 19.6533 20.6329 19.8003 20.2207 20.0758C19.8085 20.3512 19.4872 20.7427 19.2975 21.2007C19.1078 21.6588 19.0581 22.1628 19.1548 22.649C19.2516 23.1353 19.4903 23.5819 19.8409 23.9325C20.1914 24.283 20.6381 24.5218 21.1243 24.6185C21.6106 24.7152 22.1146 24.6656 22.5726 24.4758C23.0306 24.2861 23.4221 23.9648 23.6976 23.5526C23.973 23.1404 24.12 22.6558 24.12 22.16C24.12 21.4952 23.8559 20.8576 23.3858 20.3875C22.9157 19.9174 22.2782 19.6533 21.6133 19.6533V19.6533Z' fill='white' />
              </svg>
            </div>
            <span>{bracket.name}</span>
          </button>
        )}
      </div>

      <div className='de-brackets-tab-content'>
        {
          selectedTab === SUMMARY_TAB
            ? <BracketsOverview brackets={brackets} onClickView={handleViewBracket} />
            : <BracketDetail
              tournament_name={tournamentCtx.detail.name}
              bracket_id={selectedTab}
            />
        }
      </div>
    </div>
  )
}
