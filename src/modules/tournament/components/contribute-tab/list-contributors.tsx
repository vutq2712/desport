import { useCallback, useEffect, useState } from "react";
import { useRouter } from "next/router";
import { getContributors, ContributorInfo } from "@app/api/tournament/contributor/get-contributors";
import { DePagination, PageChangeData } from "@app/dekits/pagination";
import { useSubscription } from "@app/hooks/subscription";
import { formatNumber } from "@app/dekits/utils/number-format";

const mapTopContributor = [
  {
    className: 'gold',
    icon: <svg width='16' height='16' viewBox='0 0 16 16' fill='none' xmlns='http://www.w3.org/2000/svg'>
      <path d='M8 14.4399C7.86793 14.4382 7.74175 14.3849 7.64836 14.2915C7.55496 14.1981 7.50173 14.072 7.5 13.9399V10.2266C7.5 10.094 7.55268 9.96678 7.64645 9.87301C7.74022 9.77924 7.86739 9.72656 8 9.72656C8.13261 9.72656 8.25978 9.77924 8.35355 9.87301C8.44732 9.96678 8.5 10.094 8.5 10.2266V13.9399C8.49827 14.072 8.44504 14.1981 8.35164 14.2915C8.25825 14.3849 8.13207 14.4382 8 14.4399Z' fill='#E59C50' />
      <path d='M7.99996 10.7268C6.98153 10.7268 6.00481 10.3222 5.28467 9.60206C4.56453 8.88192 4.15996 7.9052 4.15996 6.88677V2.43343C4.14981 2.28917 4.14981 2.14437 4.15996 2.0001C4.16827 1.93488 4.18936 1.87193 4.222 1.81485C4.25464 1.75778 4.29821 1.70769 4.35021 1.66745C4.40221 1.62721 4.46163 1.59761 4.52507 1.58034C4.58851 1.56306 4.65473 1.55845 4.71996 1.56677C4.78518 1.57508 4.84813 1.59617 4.9052 1.62881C4.96228 1.66145 5.01237 1.70502 5.0526 1.75702C5.09284 1.80902 5.12245 1.86844 5.13972 1.93188C5.157 1.99532 5.16161 2.06154 5.15329 2.12677C5.14622 2.22887 5.14622 2.33133 5.15329 2.43343V6.88677C5.15329 7.63998 5.4525 8.36235 5.98511 8.89495C6.51771 9.42755 7.24008 9.72677 7.99329 9.72677C8.74651 9.72677 9.46887 9.42755 10.0015 8.89495C10.5341 8.36235 10.8333 7.63998 10.8333 6.88677V2.43343C10.8404 2.33133 10.8404 2.22887 10.8333 2.12677C10.8363 2.0075 10.8819 1.89325 10.9618 1.80465C11.0418 1.71606 11.1507 1.65896 11.269 1.64366C11.3874 1.62837 11.5073 1.65589 11.6071 1.72126C11.7069 1.78662 11.78 1.88552 11.8133 2.0001C11.8234 2.14437 11.8234 2.28917 11.8133 2.43343V6.88677C11.8133 7.90059 11.4124 8.87329 10.698 9.59267C9.98364 10.312 9.01376 10.7197 7.99996 10.7268Z' fill='#E59C50' />
      <path d='M11.7001 6.66668C11.6085 6.66588 11.5187 6.64056 11.4401 6.59334L11.0801 6.38001C10.9724 6.31124 10.8951 6.20383 10.8641 6.07984C10.8331 5.95586 10.8508 5.82471 10.9135 5.71334C10.98 5.60321 11.087 5.52344 11.2115 5.49106C11.3361 5.45868 11.4684 5.47624 11.5801 5.54001L11.8135 5.68001C13.5935 5.54668 14.0001 3.52001 14.1335 2.56001H1.86681C1.96014 3.52668 2.38681 5.54668 4.16681 5.64001L4.40014 5.50001C4.51192 5.43624 4.64419 5.41868 4.76874 5.45106C4.89328 5.48344 5.00025 5.56321 5.06681 5.67334C5.12949 5.78471 5.14715 5.91586 5.11615 6.03984C5.08516 6.16383 5.00786 6.27124 4.90014 6.34001L4.54014 6.55334C4.46158 6.60056 4.3718 6.62588 4.28014 6.62668C1.54014 6.62668 0.813477 3.62668 0.813477 2.04001C0.820385 1.90797 0.878634 1.78386 0.975789 1.69418C1.07294 1.6045 1.20131 1.55635 1.33348 1.56001H14.6668C14.7989 1.56174 14.9251 1.61497 15.0185 1.70836C15.1119 1.80176 15.1651 1.92794 15.1668 2.06001C15.1668 3.64668 14.4401 6.66668 11.7001 6.66668Z' fill='#E59C50' />
      <path d='M11.7135 14.4399H5.04688C4.91427 14.4399 4.78709 14.3873 4.69332 14.2935C4.59955 14.1997 4.54688 14.0725 4.54688 13.9399C4.54688 13.8073 4.59955 13.6802 4.69332 13.5864C4.78709 13.4926 4.91427 13.4399 5.04688 13.4399H11.7135C11.8461 13.4399 11.9733 13.4926 12.0671 13.5864C12.1609 13.6802 12.2135 13.8073 12.2135 13.9399C12.2135 14.0725 12.1609 14.1997 12.0671 14.2935C11.9733 14.3873 11.8461 14.4399 11.7135 14.4399Z' fill='#E59C50' />
    </svg>
  },
  {
    className: 'silver',
    icon: <svg width='16' height='16' viewBox='0 0 16 16' fill='none' xmlns='http://www.w3.org/2000/svg'>
      <path d='M8 14.4399C7.86793 14.4382 7.74175 14.3849 7.64836 14.2915C7.55496 14.1981 7.50173 14.072 7.5 13.9399V10.2266C7.5 10.094 7.55268 9.96678 7.64645 9.87301C7.74022 9.77924 7.86739 9.72656 8 9.72656C8.13261 9.72656 8.25978 9.77924 8.35355 9.87301C8.44732 9.96678 8.5 10.094 8.5 10.2266V13.9399C8.49827 14.072 8.44504 14.1981 8.35164 14.2915C8.25825 14.3849 8.13207 14.4382 8 14.4399Z' fill='#B1B7E1' />
      <path d='M7.99996 10.7268C6.98153 10.7268 6.00481 10.3222 5.28467 9.60206C4.56453 8.88192 4.15996 7.9052 4.15996 6.88677V2.43343C4.14981 2.28917 4.14981 2.14437 4.15996 2.0001C4.16827 1.93488 4.18936 1.87193 4.222 1.81485C4.25464 1.75778 4.29821 1.70769 4.35021 1.66745C4.40221 1.62721 4.46163 1.59761 4.52507 1.58034C4.58851 1.56306 4.65473 1.55845 4.71996 1.56677C4.78518 1.57508 4.84813 1.59617 4.9052 1.62881C4.96228 1.66145 5.01237 1.70502 5.0526 1.75702C5.09284 1.80902 5.12245 1.86844 5.13972 1.93188C5.157 1.99532 5.16161 2.06154 5.15329 2.12677C5.14622 2.22887 5.14622 2.33133 5.15329 2.43343V6.88677C5.15329 7.63998 5.4525 8.36235 5.98511 8.89495C6.51771 9.42755 7.24008 9.72677 7.99329 9.72677C8.74651 9.72677 9.46887 9.42755 10.0015 8.89495C10.5341 8.36235 10.8333 7.63998 10.8333 6.88677V2.43343C10.8404 2.33133 10.8404 2.22887 10.8333 2.12677C10.8363 2.0075 10.8819 1.89325 10.9618 1.80465C11.0418 1.71606 11.1507 1.65896 11.269 1.64366C11.3874 1.62837 11.5073 1.65589 11.6071 1.72126C11.7069 1.78662 11.78 1.88552 11.8133 2.0001C11.8234 2.14437 11.8234 2.28917 11.8133 2.43343V6.88677C11.8133 7.90059 11.4124 8.87329 10.698 9.59267C9.98364 10.312 9.01376 10.7197 7.99996 10.7268Z' fill='#B1B7E1' />
      <path d='M11.7001 6.66668C11.6085 6.66588 11.5187 6.64056 11.4401 6.59334L11.0801 6.38001C10.9724 6.31124 10.8951 6.20383 10.8641 6.07984C10.8331 5.95586 10.8508 5.82471 10.9135 5.71334C10.98 5.60321 11.087 5.52344 11.2115 5.49106C11.3361 5.45868 11.4684 5.47624 11.5801 5.54001L11.8135 5.68001C13.5935 5.54668 14.0001 3.52001 14.1335 2.56001H1.86681C1.96014 3.52668 2.38681 5.54668 4.16681 5.64001L4.40014 5.50001C4.51192 5.43624 4.64419 5.41868 4.76874 5.45106C4.89328 5.48344 5.00025 5.56321 5.06681 5.67334C5.12949 5.78471 5.14715 5.91586 5.11615 6.03984C5.08516 6.16383 5.00786 6.27124 4.90014 6.34001L4.54014 6.55334C4.46158 6.60056 4.3718 6.62588 4.28014 6.62668C1.54014 6.62668 0.813477 3.62668 0.813477 2.04001C0.820385 1.90797 0.878634 1.78386 0.975789 1.69418C1.07294 1.6045 1.20131 1.55635 1.33348 1.56001H14.6668C14.7989 1.56174 14.9251 1.61497 15.0185 1.70836C15.1119 1.80176 15.1651 1.92794 15.1668 2.06001C15.1668 3.64668 14.4401 6.66668 11.7001 6.66668Z' fill='#B1B7E1' />
      <path d='M11.7135 14.4399H5.04688C4.91427 14.4399 4.78709 14.3873 4.69332 14.2935C4.59955 14.1997 4.54688 14.0725 4.54688 13.9399C4.54688 13.8073 4.59955 13.6802 4.69332 13.5864C4.78709 13.4926 4.91427 13.4399 5.04688 13.4399H11.7135C11.8461 13.4399 11.9733 13.4926 12.0671 13.5864C12.1609 13.6802 12.2135 13.8073 12.2135 13.9399C12.2135 14.0725 12.1609 14.1997 12.0671 14.2935C11.9733 14.3873 11.8461 14.4399 11.7135 14.4399Z' fill='#B1B7E1' />
    </svg>
  },
  {
    className: 'bronze',
    icon: <svg width='16' height='16' viewBox='0 0 16 16' fill='none' xmlns='http://www.w3.org/2000/svg'>
      <path d='M8 14.4399C7.86793 14.4382 7.74175 14.3849 7.64836 14.2915C7.55496 14.1981 7.50173 14.072 7.5 13.9399V10.2266C7.5 10.094 7.55268 9.96678 7.64645 9.87301C7.74022 9.77924 7.86739 9.72656 8 9.72656C8.13261 9.72656 8.25978 9.77924 8.35355 9.87301C8.44732 9.96678 8.5 10.094 8.5 10.2266V13.9399C8.49827 14.072 8.44504 14.1981 8.35164 14.2915C8.25825 14.3849 8.13207 14.4382 8 14.4399Z' fill='#954000' />
      <path d='M7.99996 10.7268C6.98153 10.7268 6.00481 10.3222 5.28467 9.60206C4.56453 8.88192 4.15996 7.9052 4.15996 6.88677V2.43343C4.14981 2.28917 4.14981 2.14437 4.15996 2.0001C4.16827 1.93488 4.18936 1.87193 4.222 1.81485C4.25464 1.75778 4.29821 1.70769 4.35021 1.66745C4.40221 1.62721 4.46163 1.59761 4.52507 1.58034C4.58851 1.56306 4.65473 1.55845 4.71996 1.56677C4.78518 1.57508 4.84813 1.59617 4.9052 1.62881C4.96228 1.66145 5.01237 1.70502 5.0526 1.75702C5.09284 1.80902 5.12245 1.86844 5.13972 1.93188C5.157 1.99532 5.16161 2.06154 5.15329 2.12677C5.14622 2.22887 5.14622 2.33133 5.15329 2.43343V6.88677C5.15329 7.63998 5.4525 8.36235 5.98511 8.89495C6.51771 9.42755 7.24008 9.72677 7.99329 9.72677C8.74651 9.72677 9.46887 9.42755 10.0015 8.89495C10.5341 8.36235 10.8333 7.63998 10.8333 6.88677V2.43343C10.8404 2.33133 10.8404 2.22887 10.8333 2.12677C10.8363 2.0075 10.8819 1.89325 10.9618 1.80465C11.0418 1.71606 11.1507 1.65896 11.269 1.64366C11.3874 1.62837 11.5073 1.65589 11.6071 1.72126C11.7069 1.78662 11.78 1.88552 11.8133 2.0001C11.8234 2.14437 11.8234 2.28917 11.8133 2.43343V6.88677C11.8133 7.90059 11.4124 8.87329 10.698 9.59267C9.98364 10.312 9.01376 10.7197 7.99996 10.7268Z' fill='#954000' />
      <path d='M11.7001 6.66668C11.6085 6.66588 11.5187 6.64056 11.4401 6.59334L11.0801 6.38001C10.9724 6.31124 10.8951 6.20383 10.8641 6.07984C10.8331 5.95586 10.8508 5.82471 10.9135 5.71334C10.98 5.60321 11.087 5.52344 11.2115 5.49106C11.3361 5.45868 11.4684 5.47624 11.5801 5.54001L11.8135 5.68001C13.5935 5.54668 14.0001 3.52001 14.1335 2.56001H1.86681C1.96014 3.52668 2.38681 5.54668 4.16681 5.64001L4.40014 5.50001C4.51192 5.43624 4.64419 5.41868 4.76874 5.45106C4.89328 5.48344 5.00025 5.56321 5.06681 5.67334C5.12949 5.78471 5.14715 5.91586 5.11615 6.03984C5.08516 6.16383 5.00786 6.27124 4.90014 6.34001L4.54014 6.55334C4.46158 6.60056 4.3718 6.62588 4.28014 6.62668C1.54014 6.62668 0.813477 3.62668 0.813477 2.04001C0.820385 1.90797 0.878634 1.78386 0.975789 1.69418C1.07294 1.6045 1.20131 1.55635 1.33348 1.56001H14.6668C14.7989 1.56174 14.9251 1.61497 15.0185 1.70836C15.1119 1.80176 15.1651 1.92794 15.1668 2.06001C15.1668 3.64668 14.4401 6.66668 11.7001 6.66668Z' fill='#954000' />
      <path d='M11.7135 14.4399H5.04688C4.91427 14.4399 4.78709 14.3873 4.69332 14.2935C4.59955 14.1997 4.54688 14.0725 4.54688 13.9399C4.54688 13.8073 4.59955 13.6802 4.69332 13.5864C4.78709 13.4926 4.91427 13.4399 5.04688 13.4399H11.7135C11.8461 13.4399 11.9733 13.4926 12.0671 13.5864C12.1609 13.6802 12.2135 13.8073 12.2135 13.9399C12.2135 14.0725 12.1609 14.1997 12.0671 14.2935C11.9733 14.3873 11.8461 14.4399 11.7135 14.4399Z' fill='#954000' />
    </svg>
  }
]

const pageSize = 20;

export function ListContributors() {
  const [contributors, changeContributors] = useState<ContributorInfo[]>([]);
  const subscription = useSubscription();
  const router = useRouter();
  const [paging, changePaging] = useState({
    currentPage: 1,
    totalItems: 0,
    pageSize,
  })

  const onGetContributors = useCallback((currentPage) => {
    const params = {
      tournament: router.query.tournamentId as string,
      page: currentPage,
      limit: paging.pageSize,
    }
    const sub = getContributors(params).subscribe({
      next: res => {
        changePaging({
          currentPage: Number(res.data.page_num),
          totalItems: Number(res.data.total),
          pageSize,
        })
        changeContributors(res.data.contributors);
      },
      error: error => alert(error?.response?.msg || 'Error'),
    })

    subscription.add(sub);
  }, [])

  useEffect(() => {
    onGetContributors(paging.currentPage);
  }, [])

  const getUnits = (listCurrency: Array<{currency: string, [key: string]: any}>) => {
    if (!listCurrency || !listCurrency.length) return '';

    return listCurrency.map(item => item.currency).join(', ');
  }

  const handlePageChange = useCallback((data: PageChangeData) => {
    onGetContributors(data.page);
  }, [])

  return (
    <>
      <div className='de-card de-py-4 de-px-5'>
        <div className='de-card-header de-mb-2'>
          <div className='de-card-title'>contributions</div>
        </div>
        <div className='de-card-body'>
          <div className='table-responsive'>
            <table className='table de-table table-borderless mb-0'>
              <tbody>
                <tr >
                  <th>User</th>
                  <th className='de-px-2'>Amount</th>
                  <th className='text-center' style={{ width: 200 }}>Unit</th>
                </tr>

                {contributors.map((contributor, index) => (
                  <tr key={index}>
                    <td>
                      <img src={contributor.user_info.avatar || '/assets/images/team-logo-3.png'} alt={contributor.user_info.name} height={32} />
                      <span className='de-ms-1'>{contributor.user_info.name}</span>
                    </td>
                    <td>
                      {(index < mapTopContributor.length) && (
                        <span className={mapTopContributor[index].className}>{formatNumber(contributor.total_amount || 0)}
                          {mapTopContributor[index].icon}
                        </span>
                      )}
                      {(index >= mapTopContributor.length) && formatNumber(contributor.total_amount || 0)}
                    </td>
                    <td>{getUnits(contributor.list_currency)}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <DePagination
        currentPage={paging.currentPage}
        totalItems={paging.totalItems}
        pageSize={paging.pageSize}
        onPageChange={handlePageChange}
        className='de-mx-5'
      />
    </>
  )
}
